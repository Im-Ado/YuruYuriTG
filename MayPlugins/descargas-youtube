const yts = require('yt-search');
const { yta, ytv } = require('@soymaycol/maytube');
const fetch = require('node-fetch'); // si usas Node.js < 18
const limit = 100; // MB

module.exports = (bot) => {
  // AUDIO
  bot.onText(/^\/playaudio (.+)/, async (msg, match) => {
    const chatId = msg.chat.id;
    const query = match[1];

    bot.sendMessage(chatId, 'ğŸ” Buscando audio en YouTube...');

    try {
      const res = await yts(query);
      if (!res?.all?.length) return bot.sendMessage(chatId, 'âŒ No encontrÃ© resultados.');

      const video = res.all[0];
      const info = `ğŸµ *${video.title}*\nğŸ“º Canal: ${video.author.name}\nğŸ•’ DuraciÃ³n: ${video.duration.timestamp}\nğŸ”— ${video.url}`;
      await bot.sendMessage(chatId, `â³ Descargando audio...\n\n${info}`, { parse_mode: "Markdown" });

      const result = await yta(video.url);
      if (!result?.result?.download) throw new Error("Error al obtener el enlace de audio");

      await bot.sendAudio(chatId, result.result.download, {
        caption: `ğŸ¶ ${result.result.title || video.title}`,
      });
    } catch (e) {
      console.error(e);
      bot.sendMessage(chatId, `âŒ Error:\n${e.message}`);
    }
  });

  // VIDEO
  bot.onText(/^\/playvideo (.+)/, async (msg, match) => {
    const chatId = msg.chat.id;
    const query = match[1];

    bot.sendMessage(chatId, 'ğŸ” Buscando video en YouTube...');

    try {
      const res = await yts(query);
      if (!res?.all?.length) return bot.sendMessage(chatId, 'âŒ No encontrÃ© resultados.');

      const video = res.all[0];
      const info = `ğŸ“¹ *${video.title}*\nğŸ“º Canal: ${video.author.name}\nğŸ•’ DuraciÃ³n: ${video.duration.timestamp}\nğŸ”— ${video.url}`;
      await bot.sendMessage(chatId, `â³ Descargando video...\n\n${info}`, { parse_mode: "Markdown" });

      const result = await ytv(video.url);
      if (!result?.url) throw new Error("Error al obtener el enlace de video");

      // Revisar tamaÃ±o
      let sizemb = 0;
      try {
        const head = await fetch(result.url, { method: 'HEAD' });
        const size = head.headers.get('content-length');
        if (size) sizemb = parseInt(size) / (1024 * 1024);
      } catch (e) {
        console.log("âš ï¸ No se pudo obtener el tamaÃ±o del video");
      }

      if (sizemb > limit) {
        return bot.sendMessage(chatId, `ğŸš« El video pesa ${sizemb.toFixed(2)}MB. El lÃ­mite es ${limit}MB.`);
      }

      await bot.sendVideo(chatId, result.url, {
        caption: `ğŸ¬ ${result.title || video.title}`,
      });
    } catch (e) {
      console.error(e);
      bot.sendMessage(chatId, `âŒ Error:\n${e.message}`);
    }
  });
};
