const TelegramBot = require('@soymaycol/maytelegram');
const fs = require('fs');
const path = require('path');
const readline = require('readline');

// Colores ANSI para consola
const colors = {
    reset: '\x1b[0m',
    bright: '\x1b[1m',
    dim: '\x1b[2m',
    red: '\x1b[31m',
    green: '\x1b[32m',
    yellow: '\x1b[33m',
    blue: '\x1b[34m',
    magenta: '\x1b[35m',
    cyan: '\x1b[36m',
    white: '\x1b[37m',
    bgRed: '\x1b[41m',
    bgGreen: '\x1b[42m',
    bgYellow: '\x1b[43m',
    bgBlue: '\x1b[44m',
    bgMagenta: '\x1b[45m',
    bgCyan: '\x1b[46m'
};

// ASCII Art del bot
const botAscii = `
${colors.cyan}
‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó
‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë  ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë
‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù
                                                                    
${colors.yellow}        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
${colors.yellow}        ‚ïë     ü§ñ MaycolAIUltraMD Bot ü§ñ        ‚ïë
${colors.yellow}        ‚ïë        Created by SoyMaycol         ‚ïë
${colors.yellow}        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
${colors.reset}
`;

// Funci√≥n para mostrar mensajes con colores
function log(message, color = 'white') {
    const timestamp = new Date().toLocaleString();
    console.log(`${colors[color]}[${timestamp}] ${message}${colors.reset}`);
}

// Funci√≥n para mostrar el estado del bot
function showBotStatus(status, color) {
    console.log(`${colors[color]}
‚ïî${'‚ïê'.repeat(50)}‚ïó
‚ïë${' '.repeat(18)}BOT STATUS${' '.repeat(18)}‚ïë
‚ïë${' '.repeat(50)}‚ïë
‚ïë  ${status.padEnd(46)}  ‚ïë
‚ïö${'‚ïê'.repeat(50)}‚ïù
${colors.reset}`);
}

// Configuraci√≥n de archivos
const configPath = path.join(__dirname, 'config.json');
const pluginsPath = path.join(__dirname, 'MayPlugins');

// Funci√≥n para cargar configuraci√≥n
function loadConfig() {
    try {
        if (fs.existsSync(configPath)) {
            const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
            return config;
        }
    } catch (error) {
        log('Error al cargar configuraci√≥n', 'red');
    }
    return null;
}

// Funci√≥n para guardar configuraci√≥n
function saveConfig(token) {
    try {
        const config = { token: token, lastConnection: Date.now() };
        fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
        log('Configuraci√≥n guardada exitosamente', 'green');
    } catch (error) {
        log('Error al guardar configuraci√≥n', 'red');
    }
}

// Funci√≥n para solicitar token
function askForToken() {
    return new Promise((resolve) => {
        const rl = readline.createInterface({
            input: process.stdin,
            output: process.stdout
        });

        console.log(`${colors.yellow}
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                  üîê TOKEN REQUERIDO üîê                  ‚ïë
‚ïë                                                        ‚ïë
‚ïë  Por favor ingresa tu token de Telegram Bot:           ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${colors.reset}`);

        rl.question(`${colors.cyan}üìù Token: ${colors.reset}`, (token) => {
            rl.close();
            resolve(token.trim());
        });
    });
}

// Funci√≥n para validar token
function validateToken(token) {
    return token && token.includes(':') && token.length > 20;
}

// Funci√≥n para cargar plugins
function loadPlugins(bot) {
    let pluginCount = 0;
    
    if (!fs.existsSync(pluginsPath)) {
        fs.mkdirSync(pluginsPath, { recursive: true });
        log('Carpeta MayPlugins creada', 'yellow');
        return 0;
    }

    const files = fs.readdirSync(pluginsPath);
    
    files.forEach(file => {
        if (file.endsWith('.js')) {
            try {
                const pluginPath = path.join(pluginsPath, file);
                // Limpiar cach√© del require para recargas
                delete require.cache[require.resolve(pluginPath)];
                const handler = require(pluginPath);
                
                if (typeof handler === 'function') {
                    handler(bot);
                    pluginCount++;
                    log(`Plugin cargado: ${file}`, 'green');
                } else {
                    log(`Plugin inv√°lido: ${file}`, 'yellow');
                }
            } catch (error) {
                log(`Error cargando plugin ${file}: ${error.message}`, 'red');
            }
        }
    });
    
    return pluginCount;
}

// Funci√≥n para manejar mensajes del bot
function setupMessageHandler(bot) {
    bot.on('message', (msg) => {
        const chatId = msg.chat.id;
        const userId = msg.from.id;
        const userName = msg.from.username || msg.from.first_name || 'Usuario';
        const messageText = msg.text || '[Archivo/Media]';
        const chatType = msg.chat.type;
        const chatTitle = msg.chat.title || 'Chat Privado';

        // Log del mensaje recibido
        console.log(`${colors.magenta}
‚îå${'‚îÄ'.repeat(60)}‚îê
‚îÇ üì® MENSAJE RECIBIDO                                      ‚îÇ
‚îú${'‚îÄ'.repeat(60)}‚î§
‚îÇ üë§ Usuario: ${userName.padEnd(43)} ‚îÇ
‚îÇ üÜî User ID: ${userId.toString().padEnd(42)} ‚îÇ
‚îÇ üí¨ Chat: ${chatTitle.padEnd(46)} ‚îÇ
‚îÇ üìù Tipo: ${chatType.padEnd(46)} ‚îÇ
‚îÇ üî§ Mensaje: ${messageText.slice(0, 40).padEnd(40)} ‚îÇ
‚îî${'‚îÄ'.repeat(60)}‚îò${colors.reset}`);
    });

    bot.on('polling_error', (error) => {
        log(`Polling Error: ${error.message}`, 'red');
    });

    bot.on('error', (error) => {
        log(`Bot Error: ${error.message}`, 'red');
    });
}

// Funci√≥n principal
async function startBot() {
    console.clear();
    console.log(botAscii);
    
    showBotStatus('üîç Iniciando sistema...', 'cyan');
    
    let token;
    let config = loadConfig();
    
    if (config && config.token && validateToken(config.token)) {
        log('Token encontrado en configuraci√≥n', 'green');
        token = config.token;
        
        // Mostrar √∫ltima conexi√≥n
        const lastConnection = new Date(config.lastConnection).toLocaleString();
        log(`√öltima conexi√≥n: ${lastConnection}`, 'cyan');
    } else {
        log('Token no encontrado o inv√°lido', 'yellow');
        token = await askForToken();
        
        if (!validateToken(token)) {
            log('‚ùå Token inv√°lido. El bot se cerrar√°.', 'red');
            process.exit(1);
        }
        
        saveConfig(token);
    }

    showBotStatus('üîó Conectando al bot...', 'yellow');
    
    try {
        const bot = new TelegramBot(token, { 
            polling: {
                interval: 300,
                autoStart: true,
                params: {
                    timeout: 10
                }
            }
        });

        // Configurar manejadores de mensajes
        setupMessageHandler(bot);

        // Verificar conexi√≥n
        const botInfo = await bot.getMe();
        
        showBotStatus('‚úÖ Bot conectado exitosamente', 'green');
        
        console.log(`${colors.green}
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                   üéâ BOT INFORMACI√ìN üéâ                 ‚ïë
‚ïë                                                        ‚ïë
‚ïë  ü§ñ Nombre: ${botInfo.first_name.padEnd(37)} ‚ïë
‚ïë  üë§ Usuario: @${botInfo.username.padEnd(35)} ‚ïë
‚ïë  üÜî ID: ${botInfo.id.toString().padEnd(41)} ‚ïë
‚ïë  üìÖ Iniciado: ${new Date().toLocaleString().padEnd(33)} ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${colors.reset}`);

        // Cargar plugins
        log('üîå Cargando plugins...', 'cyan');
        const pluginCount = loadPlugins(bot);
        
        if (pluginCount > 0) {
            log(`‚úÖ ${pluginCount} plugins cargados exitosamente`, 'green');
        } else {
            log('‚ö†Ô∏è No se encontraron plugins', 'yellow');
        }

        showBotStatus('üöÄ Bot funcionando correctamente', 'green');
        
        log('Bot iniciado correctamente. Presiona Ctrl+C para detener.', 'bright');

        // Manejar cierre graceful
        process.on('SIGINT', () => {
            log('Deteniendo bot...', 'yellow');
            bot.stopPolling();
            showBotStatus('‚èπÔ∏è Bot detenido', 'red');
            process.exit(0);
        });

    } catch (error) {
        showBotStatus('‚ùå Error de conexi√≥n', 'red');
        log(`Error: ${error.message}`, 'red');
        
        if (error.message.includes('401')) {
            log('Token inv√°lido. Eliminando configuraci√≥n...', 'yellow');
            if (fs.existsSync(configPath)) {
                fs.unlinkSync(configPath);
            }
            log('Reinicia el bot para ingresar un nuevo token', 'cyan');
        }
        
        process.exit(1);
    }
}

// Crear carpeta de plugins si no existe
if (!fs.existsSync(pluginsPath)) {
    fs.mkdirSync(pluginsPath, { recursive: true });
    log('Carpeta MayPlugins creada', 'green');
}

// Iniciar el bot
startBot().catch(error => {
    console.error('Error fatal:', error);
    process.exit(1);
});
